<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω License</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-card.pending {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        }

        .stat-card.approved {
            background: linear-gradient(135deg, #55efc4 0%, #81ecec 100%);
        }

        .stat-card.rejected {
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #555;
        }

        select,
        input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            white-space: nowrap;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
            vertical-align: top;
        }

        tr:hover td {
            background: #f8f9ff;
        }

        .status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .status.pending {
            background: #ffeaa7;
            color: #e17055;
        }

        .status.approved {
            background: #55efc4;
            color: #00b894;
        }

        .status.rejected {
            background: #ff7675;
            color: #d63031;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            min-width: 120px;
        }

        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            white-space: nowrap;
            flex: 1;
            min-width: 60px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-approve {
            background: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #d63031 0%, #ff7675 100%);
            color: white;
        }

        .btn-view {
            background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #e84118 0%, #c44569 100%);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: bold;
            color: #555;
            min-width: 120px;
        }

        .detail-value {
            flex: 1;
            word-break: break-all;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 15px;
            }

            .filters {
                flex-direction: column;
                gap: 10px;
            }

            .filter-group {
                width: 100%;
            }

            select, input {
                width: 100%;
                padding: 12px;
                font-size: 16px; /* Prevent zoom on iOS */
            }

            .table-container {
                margin: 0 -15px;
                border-radius: 0;
            }

            table {
                font-size: 12px;
                min-width: 700px;
            }

            th, td {
                padding: 8px 6px;
            }

            .action-buttons {
                gap: 3px;
                min-width: 100px;
            }

            .btn {
                padding: 4px 6px;
                font-size: 10px;
                min-width: 45px;
            }

            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                padding: 20px;
                max-height: 90vh;
            }

            .detail-row {
                flex-direction: column;
                gap: 5px;
            }

            .detail-label {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            table {
                min-width: 650px;
            }

            th, td {
                padding: 6px 4px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 2px;
                min-width: 80px;
            }

            .btn {
                padding: 6px 4px;
                font-size: 9px;
                min-width: auto;
                width: 100%;
            }
        }

        /* ƒê·∫£m b·∫£o c√°c n√∫t lu√¥n hi·ªÉn th·ªã */
        .action-buttons .btn {
            display: block !important;
        }

        /* C·∫£i thi·ªán hi·ªÉn th·ªã tr√™n m√†n h√¨nh nh·ªè */
        @media (max-width: 600px) {
            .table-container {
                position: relative;
            }
            
            .table-container::after {
                content: "‚Üê Vu·ªët ƒë·ªÉ xem th√™m ‚Üí";
                position: absolute;
                bottom: 10px;
                right: 10px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 11px;
                pointer-events: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîë Qu·∫£n l√Ω License</h1>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>T·ªïng y√™u c·∫ßu</h3>
                <p id="totalRequests">0</p>
            </div>
            <div class="stat-card pending">
                <h3>Ch·ªù x·ª≠ l√Ω</h3>
                <p id="pendingRequests">0</p>
            </div>
            <div class="stat-card approved">
                <h3>ƒê√£ ch·∫•p nh·∫≠n</h3>
                <p id="approvedRequests">0</p>
            </div>
            <div class="stat-card rejected">
                <h3>ƒê√£ t·ª´ ch·ªëi</h3>
                <p id="rejectedRequests">0</p>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Tr·∫°ng th√°i:</label>
                <select id="statusFilter">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                    <option value="approved">ƒê√£ ch·∫•p nh·∫≠n</option>
                    <option value="rejected">ƒê√£ t·ª´ ch·ªëi</option>
                </select>
            </div>
            <div class="filter-group">
                <label>T√¨m ki·∫øm:</label>
                <input type="text" id="searchInput" placeholder="Machine ID, Computer Name...">
            </div>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Machine ID</th>
                        <th>Computer Name</th>
                        <th>User Name</th>
                        <th>Th·ªùi gian y√™u c·∫ßu</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>IP Address</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="requestsTable">
                    <tr>
                        <td colspan="7" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal chi ti·∫øt -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Chi ti·∫øt y√™u c·∫ßu</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let allRequests = [];

        // Load d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function () {
            loadRequests();

            // Th√™m event listeners cho filters
            document.getElementById('statusFilter').addEventListener('change', filterRequests);
            document.getElementById('searchInput').addEventListener('input', filterRequests);
        });

        async function loadRequests() {
            try {
                const response = await fetch('license3.php?action=get_requests');
                const data = await response.json();

                if (data.success) {
                    allRequests = data.data;
                    updateStats();
                    displayRequests(allRequests);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        function updateStats() {
            const total = allRequests.length;
            const pending = allRequests.filter(r => r.Status === 'pending').length;
            const approved = allRequests.filter(r => r.Status === 'approved').length;
            const rejected = allRequests.filter(r => r.Status === 'rejected').length;

            document.getElementById('totalRequests').textContent = total;
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('approvedRequests').textContent = approved;
            document.getElementById('rejectedRequests').textContent = rejected;
        }

        function displayRequests(requests) {
            const tbody = document.getElementById('requestsTable');

            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(request => `
                <tr>
                    <td>${request.MachineId || 'N/A'}</td>
                    <td>${request.ComputerName || 'N/A'}</td>
                    <td>${request.UserName || 'N/A'}</td>
                    <td>${formatDate(request.RequestTime || request.CreatedAt)}</td>
                    <td><span class="status ${request.Status}">${getStatusText(request.Status)}</span></td>
                    <td>${request.IPAddress || 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="showDetail('${request._id}')">Chi ti·∫øt</button>
                            ${request.Status === 'pending' ? `
                                <button class="btn btn-approve" onclick="processRequest('${request._id}', 'approve')">Ch·∫•p nh·∫≠n</button>
                                <button class="btn btn-reject" onclick="processRequest('${request._id}', 'reject')">T·ª´ ch·ªëi</button>
                            ` : ''}
                            <button class="btn btn-delete" onclick="deleteRequest('${request._id}')">X√≥a</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterRequests() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allRequests;

            if (statusFilter) {
                filtered = filtered.filter(r => r.Status === statusFilter);
            }

            if (searchText) {
                filtered = filtered.filter(r =>
                    (r.MachineId || '').toLowerCase().includes(searchText) ||
                    (r.ComputerName || '').toLowerCase().includes(searchText) ||
                    (r.UserName || '').toLowerCase().includes(searchText)
                );
            }

            displayRequests(filtered);
        }

        async function processRequest(requestId, action) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action === 'approve' ? 'ch·∫•p nh·∫≠n' : 't·ª´ ch·ªëi'} y√™u c·∫ßu n√†y?`)) {
                return;
            }

            try {
                const response = await fetch('license3.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'process_request',
                        requestId: requestId,
                        decision: action
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadRequests(); // Reload d·ªØ li·ªáu
                } else {
                    alert('L·ªói: ' + data.message);
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        async function deleteRequest(requestId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a y√™u c·∫ßu n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                return;
            }

            try {
                const response = await fetch('license3.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete_request',
                        requestId: requestId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadRequests(); // Reload d·ªØ li·ªáu
                } else {
                    alert('L·ªói: ' + data.message);
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        function showDetail(requestId) {
            const request = allRequests.find(r => r._id === requestId);
            if (!request) return;

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Machine ID:</span>
                    <span class="detail-value">${request.MachineId || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Computer Name:</span>
                    <span class="detail-value">${request.ComputerName || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">User Name:</span>
                    <span class="detail-value">${request.UserName || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Th·ªùi gian y√™u c·∫ßu:</span>
                    <span class="detail-value">${formatDate(request.RequestTime || request.CreatedAt)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tr·∫°ng th√°i:</span>
                    <span class="detail-value"><span class="status ${request.Status}">${getStatusText(request.Status)}</span></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">IP Address:</span>
                    <span class="detail-value">${request.IPAddress || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">User Agent:</span>
                    <span class="detail-value">${request.UserAgent || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">S·ªë l·∫ßn y√™u c·∫ßu:</span>
                    <span class="detail-value">${request.RequestCount || 1}</span>
                </div>
                ${request.LicenseKey ? `
                <div class="detail-row">
                    <span class="detail-label">License Key:</span>
                    <span class="detail-value" style="font-family: monospace; background: #f5f5f5; padding: 5px; border-radius: 5px;">${request.LicenseKey}</span>
                </div>
                ` : ''}
                ${request.ProcessedAt ? `
                <div class="detail-row">
                    <span class="detail-label">Th·ªùi gian x·ª≠ l√Ω:</span>
                    <span class="detail-value">${formatDate(request.ProcessedAt)}</span>
                </div>
                ` : ''}
            `;

            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                // Ki·ªÉm tra n·∫øu date kh√¥ng h·ª£p l·ªá
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                return date.toLocaleString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'approved': 'ƒê√£ ch·∫•p nh·∫≠n',
                'rejected': 'ƒê√£ t·ª´ ch·ªëi'
            };
            return statusMap[status] || status;
        }

        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function (event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Auto refresh m·ªói 30 gi√¢y
        setInterval(loadRequests, 30000);
    </script>
</body>

</html>